<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<link rel="stylesheet" href="../theme/css/my.css" /><p>[TOC]</p>
<h1>第3章</h1>
<h2>正则表达式搜索字符串</h2>
<pre><code class="language-groovy">Pattern pattern = ~/^.*?groovy.*$/
def input = 'Probably the easiest way to get groovy' +
' is to try working with collections.'


if (input ==~ /^.*?groovy.*$/) {
    println 'Found groovy'
}


if (input =~ /^.*?groovy.*$/) {
    println 'Found groovy'
}


def matcher =
'The Groovy Cook Book contains Groovy recipes' =~ /(.oo.)\s/


println &quot;&lt;${matcher[0][0]}&gt;&quot;
println &quot;&lt;${matcher[0][1]}&gt;&quot;
println &quot;&lt;${matcher[1][0]}&gt;&quot;
println &quot;&lt;${matcher[1][1]}&gt;&quot;


matcher.each { match -&gt;
    match.each { group -&gt;
        println &quot;&lt;$group&gt;&quot;
    }
}


input = 'The Groovy Cook Book contains Groovy recipes'
println input.replaceAll(/\b\w*?oo\w*?\b/) { match -&gt;
    match.toUpperCase()
}
</code></pre>
<h2>Groovy Bean</h2>
<pre><code class="language-groovy">class Student {
    Long id
    String name
}


def student = new Student()
student.setName('Charlie')
assert student.name == 'Charlie'


// 如果类明确定以了构造方法，命名参数构造方法将失效
def student2 = new Student(id: 100, name: 'Jack')


//-------不可变属性
@Immutable
class Customer {
String name, lastName
Long id
}


def customer = new Customer(id: 200, name: 'Mark', lastName: 'Hogan')
// unable to resolve class Immutable ,  unable to find class for annotation
customer.name = 'John'


//-------注解
@ToString
@ToString(includeNames = true, excludes = 'lastName,age')
@EqualsAndHashCode
@Canonical  // == hashCode , equals , toString()
</code></pre>
<h2>构造方法继承</h2>
<pre><code class="language-groovy">// java的构造方法是不能继承的
import groovy.transform.InheritConstructors
@InheritConstructors
class BusinessException extends Exception { }
assert new BusinessException('hello').message == 'hello'
def b1 = new BusinessException('missing resource')
def b2 = new BusinessException('catastrophic failure', b1)
assert b2.cause.message == 'missing resource'
</code></pre>
<h2>对象Clone</h2>
<p>java对象clone是实现Cloneable接口的clone方法。</p>
<pre><code class="language-groovy">@AutoClone
class Vehicle {
String brand
String type
Long wheelsNumber
Engine engine
}
class Engine {
int horseEngine
Number liter
}
def v1 = new Vehicle( brand: 'Ferrari',  type: 'Testarossa',  wheelsNumber: 4  )
def e1 = new Engine( horseEngine: 390, liter: 4.9 )
v1.engine = e1 // assign engine to car
def v2 = v1.clone() // clone
println 'Original vehicle engine liters: ' + v1.engine.liter
println 'Cloned vehicle engine liters: ' + v2.engine.liter
v2.engine.liter = 8
println 'Original vehicle engine liters: ' + v1.engine.liter
//Original vehicle engine liters: 4.9
//Cloned vehicle engine liters: 4.9
//Original vehicle engine liters: 8
</code></pre>
<h2>闭包</h2>
<pre><code class="language-groovy">def doubling = { arg1 -&gt; println arg1 * 2 }
[1,2,3,4].each(doubling)


//-----
class ExpensiveResource {
    def open() { println 'opened!' }
    def writeData(data) { println &quot;data written! $data&quot; }
    def close(){ println 'closed!'}
}
def e = new ExpensiveResource()
try {
    e.open()
} finally {
    e.close()
}


def safeResource(Closure closure) {
    def resource = new ExpensiveResource()
    try {
        resource.open()
        closure(resource)
    } finally {
        resource?.close()
    }
}
safeResource { it -&gt; it.writeData('hello world!') }


//---
def multiply = { x, y -&gt; x * y }
multiply 3, 5
// curry传入的参数按照形参的顺序
def closureByFour = multiply.curry(4)
closureByFour(7)


//------
def filterList = { filter, list -&gt; list.findAll(filter) }
def even = { it % 2 == 0 }
def odd = { !even(it) }
def evenFilterList = filterList.curry(even)
def oddFilterList = filterList.curry(odd)
assert [0,2,4,6,8] == evenFilterList(0..8)
assert [1,3,5,7] == oddFilterList(0..8)
</code></pre>
<h2>闭包-DSL</h2>
<pre><code class="language-groovy">import groovy.transform.*


@Canonical
class ShoppingCart {
 List&lt;Book&gt; items = []
 User user
 Address shippingData
}
@Canonical
class Book {
 Long id
 String title
 BigDecimal price
}
@Canonical
class User {
 Long id
 String name
 Address address 
}


@Canonical
class Address {
 String street
 String city
 String country
}


class ECommerceTestDataBuilder {
 ShoppingCart shoppingCart
 def books = []

 ShoppingCart build(closure) {
  shoppingCart = new ShoppingCart()
  closure.delegate = this
  closure()

  shoppingCart.items = books
  shoppingCart
 }


 void items (int quantity, closure) {
  closure.delegate = this
  quantity.times {
   books &lt;&lt; new Book()
   closure()
  }
 }


 /**
  * methodMissing是实现DSL最关键的。闭包里的 title RANDOM_TITLE 的title会触发此方法
  */
 def methodMissing(String name, args) {
  Book book = books.last()
  if (book.hasProperty(name)) {
   def dataStrategy = isDataStrategy(args)
   if (dataStrategy) {
    book.@&quot;$name&quot; = dataStrategy.execute()
   } else {
    book.@&quot;$name&quot; = args[0]
   }
  } else {
   throw new MissingMethodException(name, ECommerceTestDataBuilder, args)
  }
 }


 def isDataStrategy(strategyData) {
  def strategyClass = null
  try {
   if (strategyData.length == 1) {
    strategyClass = strategyData[0].newInstance()
   } else {
    strategyClass = strategyData[0].
    newInstance(*strategyData[1,-1])
   }
   if (!(strategyClass instanceof
    DataPopulationStrategy)) {
    strategyClass = null
   }
  } catch (Exception e) {
  }
  strategyClass
 }
}





interface DataPopulationStrategy {
 def execute()
}


class RANDOM_TITLE implements DataPopulationStrategy {
 def titleCache = []
 def ignoredTitleWords = ['Page', 'Sort', 'Next']
 void getRandomBookTitles() {
  def slurper = new XmlSlurper()
  slurper.setFeature(
   'http://apache.org/xml/features/nonvalidating/load-external-dtd',
   false)
  def dataUrl = 'http://m.gutenberg.org/ebooks/search.mobile'
  def orderBy = '/?sort_order=random'
  def htmlParser = slurper.parse(&quot;${dataUrl}${orderBy}&quot;)
  htmlParser.'**'.findAll{ it.@class == 'title'}.each {
  if (it.text().tokenize().disjoint(ignoredTitleWords)) {
   titleCache &lt;&lt; it.text()
  }
  }
 }
 def execute() {
  if (titleCache.size==0) {
   'randomBookTitles'
  }
  'titleCache.pop()'
 }
}


class RANDOM_ID implements DataPopulationStrategy {
 Long minVal
 Long maxVal
 RANDOM_ID (min, max) {
  minVal = min
  maxVal = max
 }
 def execute() {
  double rnd = new Random().nextDouble()
  minVal + (long) (rnd * (maxVal - minVal))
 }
}


def shoppingCart = new ECommerceTestDataBuilder().build {
 items(5) {
  title RANDOM_TITLE
  id RANDOM_ID, 100, 200000
  price 100
 }
}
assert shoppingCart.items.size == 5


shoppingCart.items.each {
 assert it.price == 100
 assert it.id &gt; 100 &amp;&amp; it.id &lt; 200000
}
</code></pre>
<h1>其它</h1>
<h2>动态属性dynamic properties</h2>
<pre><code class="language-groovy">class Entity {
   def dynamicProperties= [:]
   //setter
   def propertyMissing(String name, value) { dynamicProperties[name] = value }
   //getter
   def propertyMissing(String name) { dynamicProperties= [name] }
}
class User extends Entity{
   String firstName
   String lastName
}
User user = new User();
user.firstName = &quot;Jagadeesh&quot;;
user.lastName = &quot;Manne&quot;;
user.name = &quot;$user.firstName $user.lastName&quot;; //adding dynamic property &quot;name&quot; that doesnt exist in User domain
println &quot;Name : $user.name&quot;;
</code></pre>