<p>[toc]</p>
<h2>一、FreeMarker基本</h2>
<h3>1 语法</h3>
<h4>1.1 条件判断</h4>
<pre><code class="language-html">
&lt;#if condition&gt; 
&lt;#elseif condition&gt; 
&lt;#else&gt; 
&lt;/#if&gt; 
</code></pre>
<p>其中condition是boolean值,可以进行返回boolean的表达式 
如&lt;#if (user.age &gt; 23)&gt;<!--#if--> 
  &lt;#if user.name == "mimi"&gt;<!--#if--> </p>
<p>如果condition的包含的字符没有双引号引起来,就表示这是个变量${}, 
不用在condition里使用${}来表示变量 
&lt;#if x &gt; 3&gt;<!--#if-->这种方式是错误的,因为freemarker会先解释前面那个"&gt;", 
可以使用&lt;#if (x &gt; 3)&gt;<!--#if-->或&lt;#if x &gt; 1&gt;&lt;?#if&gt; </p>
<h4>1.2 循环语句</h4>
<pre><code class="language-html">&lt;#list userList as user&gt;
…
${user!user_index}    //  从0开始计数,记录当前是第几个元素


&lt;#if  item_has_next&gt; &lt;#/if&gt;    //  测试当前的item是不是最后一个元素 


&lt;#break&gt;                    //  跳出循环 


&lt;/#list&gt;
</code></pre>
<p>索引index</p>
<pre><code class="language-html">&lt;#list 0..fields?size-1 as i&gt;
${fields[i]}
&lt;/#list&gt;
</code></pre>
<p>排序</p>
<pre><code class="language-html">

&lt;#list list?sort as l&gt;…&lt;/#list&gt;     // 升序， 序列中的变量必须是：字符串（按首字母排序）,数字，日期值。


&lt;#list userList?sort_by(“age”) as user&gt;…&lt;/#list&gt;     //  子变量排序



&lt;#list list? reverse as l&gt;…&lt;/#list&gt;     //  降序排序



&lt;#list userList?sort_by(“age”)?reverse as user&gt;…&lt;/#list&gt;     //  让用户按年龄降序排序


</code></pre>
<h4>1.3 Null处理</h4>
<pre><code class="language-html">
&lt;#if user?&gt;${user}&lt;/#if&gt;                //  如果user存在才显示 


&lt;h1&gt;Welcome ${user!&quot;Anonymous&quot;}!&lt;/h1&gt;      //  如果user为null，取&quot;!&quot;后面的默认值 


// 假设前提：user.name为null 
${user.name}     //  异常  
${user.name!}     //  显示空白  
${user.name!'vakin'}     //  若user.name不为空则显示本身的值，否则显示vakin


</code></pre>
<p>对于多级对象属性的情况使用()来防止中间的变量为null</p>
<pre><code class="language-html">


// 使用??或exists判断对象不为null，if_exists表不存在


&lt;#if (user.name)??&gt;${user.name}&lt;/#if&gt; 


&lt;#if aaa?if_exists&gt;
  aaa不存在！
&lt;/#if&gt;
&lt;#if aaa?exists&gt;
  aaa存在，值为${aaa}
&lt;/#if&gt;


${(user.name)!&quot;Anonymous&quot;} 
</code></pre>
<p>空字符串判断</p>
<pre><code class="language-html">&lt;#if (person.name)!=&quot;&quot;&gt; 
    ${(person.name)!}
&lt;/#if&gt;
</code></pre>
<h4>1.4 引入页面</h4>
<p>&lt;#include&gt; 
可以使用它导入共用的的东西,比如footer,head 
各种ftl tags可以嵌套使用 </p>
<h3>3.表达式</h3>
<p>可以在${...} &lt;#if&gt;的condition中进行各种表达式计算 
比如 +,-,*,/,% 
产生boolean值的表达式 </p>
<blockquote>
<p>, &lt;, ==, !=, &gt;=, &lt;=, &amp;&amp;, ||, ! 
当然&gt;,&gt;=比较特殊,因为它包括tags的结束符 
所以应该转义 &gt;, &gte; 
也可以使用()包裹着 </p>
</blockquote>
<h3>4.build-ins</h3>
<p>build-ins是修饰各种变量的有用funtion,比如要使用string变成大写,使用string的upper_case build-in,使用方法是在变量后加? 
如 user?upper_case 
freemarker提供了各种变量类型的许多build-ins 
常用的有 
str?html :将str中包含的html特殊字符转义,比如&lt;被转义成为&lt; 
str?cap_first : 第一个字符大写 
str?lower_case: 字符串转小写 
str?upper_case: 字符串转大写 
str?trim : 删除字符串两边空格 </p>
<p>列表有个size build-in显示列表的长度 
sequence?size </p>
<p>可以将浮点数修改为int 
-1.9?int 結果是1,只取int部分，不做各种舍取操作 </p>
<h3>5.在模板里定义变量</h3>
<p>比如&lt;#assign user="pp"&gt; 
他会隐藏module里面的user变量,如果有的话 </p>
<h3>6.命名空间</h3>
<p>默认的各种变量都是定义在main namespace中，虽然我们没有注意到 
当我们写各种模板时,我们希望各个模板的变量不要被隐藏，这时这要到命名空间了. 
当我们在主模板中引入其他模板时,这时不要使用&lt;#include&gt;了，而使用&lt;#import&gt; 
&lt;#import "/lib/my_test.ftl" as my&gt; 
这样我们要调用my_test.ftl中的变量时就用my.var调用了 </p>
<h3>7.空格处理</h3>
<p>freemarker默认是不会压缩template中的空格,也就是你写了什么就是什么 
这在一些应用可能有用,但在web应用无疑是浪费带宽,所以应该压缩一下freemarker 
的output,可以在template中用&lt;#compress&gt;包裹内容. 
但是如果每个文件都使用&lt;#compress&gt;会有点麻烦, 
也可以configuration那个freemarker的主要配置类对象中设置 
config.setWhitespaceTrip(true); (但我测试是无效) </p>
<h2>二、FreeMarker编程式操作</h2>
<h3>1.freemarker.template.Configuration</h3>
<p>这是freemarker设置的中心地方,他还负责创建新的template,缓存预编译的template. Configuration的生命周期一般是应用级的,所以一般是在应用的开始时创建Configuration. </p>
<pre><code class="language-java">Configuration config = new Configuration(); 
//get the template 
Template template = config.getTemplate(&quot;test.ftl&quot;); 
//build module 
Map root = new HashMap(); 
root.put(&quot;user&quot;,&quot;bigfan&quot;); 
//Merge data-model with template 
Writer out = new OutputStreamWriter(System.out); 
template.process(root, out); 
out.flush(); 
</code></pre>
<h3>2.freemarker的有效变量</h3>
<p>在freemarker内部,有效的变量必须是实现了freemarker.template.TemplateModel接口的java对象,但是我们之前用的String,List等并没有实现这个接口，其实这是因为freemarker使用了一种叫做object wrapping的方式将java标准类转换为相应的实现了这个接口的类. </p>
<h3>3.freemarker内部有两大数据类型: Scalar, Container</h3>
<p>其中Scalar包括 
Boolean, Number, String, Date 
基中Container包括 
Hashes, sequences, Collections </p>
<h3>4.设置Shared variables</h3>
<p>这些变量在所有的template中都是有效的. 
config.setSharedVariable("company", "Foo Inc."); </p>
<h3>5.settings是影响freemarker行为的值</h3>
<p>比如locale, number_format 
可以有三个层次的settings: 
(1).在Configuration中设置的setting，使用setter方法 
比如 
myCfg.setLocale(java.util.Locale.ITALY); 
myCfg.setNumberFormat("0.####"); 
也可以在.properties文件中定义name-value,再使用myCfg.setSetting()方法 
(2).Template层也可以设置setting,但是template是可缓存的,所以必须在template第一次创建时就设置setting,而这比较难控制 
(3).Environment层, 
template对象可以得到freemarker.core.Environment这个对象, 
再使用这个对象的setter进行设置,应该在执行template.process()之前就设置好 
(4).还可以在template文件中进行设置,使用directive 
&lt;#setting locale="it_IT"&gt; 
&lt;#setting number_format="0.####"&gt;  </p>
<h3>6.Template loaders</h3>
<p>freemarker有三种loader：文件方式,classpath,servletContext 
void setDirectoryForTemplateLoading(File dir); 
void setClassForTemplateLoading(Class cl, String prefix);<br />
void setServletContextForTemplateLoading(Object servletContext, String path); </p>
<h3>7.Template caching</h3>
<p>当从configuration中getTemplate()时, configuration会缓存template,所以下次再拿相同的template就不会重新创建template和解释这个template. 如果修改template文件后,freemarker会重新读取和解释这个template,默认时间是5秒钟去判断文件是否修改.有一个"update delay"相关的设置可以修改这个值. 
但是如果是使用classpath方式load模板的话,并不会提示说你已经修改了模板文件.因为在classpath的文件的默认是被认为不会被修改的. </p>
<h3>8.freemarker会用本地locale格式化数字</h3>
<p>比如10000会被输出10,000 
这有时对后端程序是有害的. 
我们可以使用 
cfg.setNumberFormat("0.######"); 
也可以使用数字的build-in "c" 比如 ${userId?c} 
也可以试试在模板文件中使用&lt;#number_format "0.######"&gt; </p>
<h3>9.freemarker的properties配置文件</h3>
<p>可以在classpath中定义freemarker.properties配置文件 
配置模板: 
template_update_delay = 30 #in seconds 
default_encoding = utf-8 
locale = utf-8 
whitespace_stripping = true 
auto_import="/WEB-INF/content/index.ftl" as p, "/WEB-INF/content2/index.ftl" as cms 
tag_syntax=auto_detect 
url_escaping_charset=UTF-8 
datetime_format=yyyy-MM-dd HH:mm:ss 
date_format=yyyy-MM-dd 
time_format=HH:mm:ss 
number_format=0.######; 
boolean_format=true,false </p>