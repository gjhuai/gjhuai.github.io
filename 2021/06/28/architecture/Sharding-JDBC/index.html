<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="[TOC] 一、什么是Sharding-JDBCSharding-JDBC定位为轻量级Java框架，在Java的JDBC层提供的额外服务。它使用客户端直连数据库，以jar包形式提供服务，无需额外部署和依赖，可理解为增强版的JDBC驱动，完全兼容JDBC和各种ORM框架。 二、Sharding-JDBC能做什么 分库 &amp; 分表 读写分离 分布式主键 分布式事务  三、适用项目框架Shardi">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2021/06/28/architecture/Sharding-JDBC/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="[TOC] 一、什么是Sharding-JDBCSharding-JDBC定位为轻量级Java框架，在Java的JDBC层提供的额外服务。它使用客户端直连数据库，以jar包形式提供服务，无需额外部署和依赖，可理解为增强版的JDBC驱动，完全兼容JDBC和各种ORM框架。 二、Sharding-JDBC能做什么 分库 &amp; 分表 读写分离 分布式主键 分布式事务  三、适用项目框架Shardi">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2021/06/28/architecture/Sharding-JDBC/_v_images/20200604065002540_18818.png">
<meta property="og:image" content="http://example.com/2021/06/28/architecture/Sharding-JDBC/_v_images/20200604065318535_1841.png">
<meta property="article:published_time" content="2021-06-28T03:26:10.806Z">
<meta property="article:modified_time" content="2020-06-04T09:16:47.000Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2021/06/28/architecture/Sharding-JDBC/_v_images/20200604065002540_18818.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-architecture/Sharding-JDBC" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/06/28/architecture/Sharding-JDBC/" class="article-date">
  <time class="dt-published" datetime="2021-06-28T03:26:10.806Z" itemprop="datePublished">2021-06-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <p>[TOC]</p>
<h1 id="一、什么是Sharding-JDBC"><a href="#一、什么是Sharding-JDBC" class="headerlink" title="一、什么是Sharding-JDBC"></a>一、什么是Sharding-JDBC</h1><p>Sharding-JDBC定位为轻量级Java框架，在Java的JDBC层提供的额外服务。它使用客户端直连数据库，以jar包形式提供服务，无需额外部署和依赖，可理解为增强版的JDBC驱动，完全兼容JDBC和各种ORM框架。</p>
<h1 id="二、Sharding-JDBC能做什么"><a href="#二、Sharding-JDBC能做什么" class="headerlink" title="二、Sharding-JDBC能做什么"></a>二、Sharding-JDBC能做什么</h1><ul>
<li>分库 &amp; 分表</li>
<li>读写分离</li>
<li>分布式主键</li>
<li>分布式事务</li>
</ul>
<h1 id="三、适用项目框架"><a href="#三、适用项目框架" class="headerlink" title="三、适用项目框架"></a>三、适用项目框架</h1><p>Sharding-JDBC适用于：</p>
<pre><code>- 任何基于Java的ORM框架，如：JPA, Hibernate, Mybatis, Spring JDBC Template或直接使用JDBC。
- 基于任何第三方的数据库连接池，如：DBCP, C3P0, BoneCP, Druid, HikariCP等。
- 支持任意实现JDBC规范的数据库，目前支持MySQL，Oracle，SQLServer和PostgreSQL。
</code></pre>
<h1 id="四、Maven依赖"><a href="#四、Maven依赖" class="headerlink" title="四、Maven依赖"></a>四、Maven依赖</h1><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- sharding jdbc 开始--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-core<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-jdbc-spring-namespace<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 如果不配置分布式事务的话配置上边两个就够了 --&gt;</span> </span><br><span class="line"><span class="comment">&lt;!-- 分布式事务引用依赖--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-transaction-2pc-xa<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>io.shardingsphere<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>sharding-transaction-spring<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;sharding.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- sharding jdbc 结束--&gt;</span></span><br><span class="line"><span class="comment">&lt;!--AspectJ AOP支持 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.aspectj<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>aspectjweaver<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>$&#123;aspectjweaver.version&#125;<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="五、读写分离"><a href="#五、读写分离" class="headerlink" title="五、读写分离"></a>五、读写分离</h1><h2 id="5-1-数据源配置"><a href="#5-1-数据源配置" class="headerlink" title="5.1 数据源配置"></a>5.1 数据源配置</h2><p>先配置数据源</p>
<p>也可以配置读写分离</p>
<p>以下配置是ds0和ds1两个数据库的主和从一共四个数据源。</p>
<p>parentDs 是数据源公共的配置，抽出去以免写重复代码。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- ds0的主--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;ds0_master&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span> <span class="attr">parent</span>=<span class="string">&quot;parentDs&quot;</span>&gt;</span> </span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ds0的从--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;ds0_slave&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span> <span class="attr">parent</span>=<span class="string">&quot;parentDs&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;sharding.connection.url.0&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ds1的主--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;ds1_master&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span> <span class="attr">parent</span>=<span class="string">&quot;parentDs&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;sharding.connection.url.1&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- ds1的从--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;ds1_slave&quot;</span> <span class="attr">class</span>=<span class="string">&quot;com.alibaba.druid.pool.DruidDataSource&quot;</span> <span class="attr">destroy-method</span>=<span class="string">&quot;close&quot;</span> <span class="attr">parent</span>=<span class="string">&quot;parentDs&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;driverClassName&quot;</span> <span class="attr">value</span>=<span class="string">&quot;&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;url&quot;</span> <span class="attr">value</span>=<span class="string">&quot;$&#123;sharding.connection.url.1&#125;&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-2-读写分离配置"><a href="#5-2-读写分离配置" class="headerlink" title="5.2 读写分离配置"></a>5.2 读写分离配置</h2><p>只配置主从不配置分库分表的情况如下，如果要配置分库分表则不需要下面这个配置。</p>
<p>master-data-source-name 是主数据源ID</p>
<p>slave-data-source-names 是从数据源ID</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">master-slave:data-source</span> <span class="attr">id</span>=<span class="string">&quot;masterSlaveDataSource&quot;</span> <span class="attr">master-data-source-name</span>=<span class="string">&quot;ds0_master, ds1_master&quot;</span> <span class="attr">slave-data-source-names</span>=<span class="string">&quot;ds0_slave, ds1_slave &quot;</span> &gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">master-slave:props</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;sql.show&quot;</span>&gt;</span>$&#123;sql_show&#125;<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;executor.size&quot;</span>&gt;</span>10<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;foo&quot;</span>&gt;</span>bar<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">master-slave:props</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">master-slave:data-source</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h2 id="5-3-读写分离和分库分表一起配置"><a href="#5-3-读写分离和分库分表一起配置" class="headerlink" title="5.3 读写分离和分库分表一起配置"></a>5.3 读写分离和分库分表一起配置</h2><p>如果读写分离和分库分表一起使用的话把主从路由配置到 shardingdata-source下就可以了。</p>
<p>sharding:master-slave-rule 的 id 就是配置出来的逻辑的数据源的名称，如果多个从的话还可以通过配置strategy-ref来配置负载均衡。</p>
<p>master-data-source 配置的是主库数据源ID 。</p>
<p>slave-data-source 配置的是从库数据源ID，多个以逗号分开。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- sharding数据源--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sharding:data-source</span> <span class="attr">id</span>=<span class="string">&quot;shardingDataSource&quot;</span>&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 读写分离的话要把所有的主从数据源都写在这里--&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">sharding:sharding-rule</span></span></span><br><span class="line"><span class="tag">            <span class="attr">data-source-names</span>=<span class="string">&quot;ds0_master,ds0_slave,ds1_master,ds1_slave &quot;</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 读写分离的路由 一主一从配置 strategy-ref  --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sharding:master-slave-rules</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">sharding:master-slave-rule</span> <span class="attr">id</span>=<span class="string">&quot;ds0&quot;</span> <span class="attr">master-data-source-name</span>=<span class="string">&quot;ds0_master&quot;</span> <span class="attr">slave-data-source-names</span>=<span class="string">&quot;ds0_slave&quot;</span>/&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">sharding:master-slave-rule</span> <span class="attr">id</span>=<span class="string">&quot;ds1&quot;</span> <span class="attr">master-data-source-name</span>=<span class="string">&quot;ds1_master&quot;</span> <span class="attr">slave-data-source-names</span>=<span class="string">&quot;ds1_slave&quot;</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">sharding:master-slave-rules</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 读写分离配置 结束--&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">sharding:table-rules</span>&gt;</span></span><br><span class="line">    &lt;!— 这里是分库分表路由的配置 --&gt;</span><br><span class="line">        <span class="tag">&lt;/<span class="name">sharding:table-rules</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">sharding:binding-table-rules</span>&gt;</span></span><br><span class="line">    &lt;!—- 绑定表的配置 --&gt; </span><br><span class="line">        <span class="tag">&lt;/<span class="name">sharding:binding-table-rules</span>&gt;</span></span><br><span class="line"> <span class="tag">&lt;/<span class="name">sharding:sharding-rule</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sharding:props</span>&gt;</span></span><br><span class="line">        <span class="comment">&lt;!-- 显示SQL --&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">prop</span> <span class="attr">key</span>=<span class="string">&quot;sql.show&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">prop</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">sharding:props</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">sharding:data-source</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="六、数据分片"><a href="#六、数据分片" class="headerlink" title="六、数据分片"></a>六、数据分片</h1><h2 id="6-1-分片支持"><a href="#6-1-分片支持" class="headerlink" title="6.1 分片支持"></a>6.1 分片支持</h2><p>Sharding-JDBC提供了5种分片策略。由于分片算法和业务实现紧密相关，因此Sharding-JDBC并未提供内置分片算法，而是通过分片策略将各种场景提炼出来，提供更高层级的抽象，并提供接口让应用开发者自行实现分片算法。</p>
<ul>
<li><strong>StandardShardingStrategy</strong></li>
</ul>
<p>标准分片策略。提供对SQL语句中的=, IN和BETWEEN AND的分片操作支持。StandardShardingStrategy只支持单分片键，提供PreciseShardingAlgorithm和RangeShardingAlgorithm两个分片算法。PreciseShardingAlgorithm是必选的，用于处理=和IN的分片；RangeShardingAlgorithm是可选的，用于处理BETWEEN AND分片，如果不配置RangeShardingAlgorithm，SQL中的BETWEEN AND将按照全库路由处理。</p>
<ul>
<li><strong>ComplexShardingStrategy</strong></li>
</ul>
<p>复合分片策略。提供对SQL语句中的=, IN和BETWEEN AND的分片操作支持。ComplexShardingStrategy支持多分片键，由于多分片键之间的关系复杂，因此Sharding-JDBC并未做过多的封装，而是直接将分片键值组合以及分片操作符交于算法接口，完全由应用开发者实现，提供最大的灵活度。</p>
<ul>
<li><strong>InlineShardingStrategy</strong></li>
</ul>
<p>Inline表达式分片策略。使用Groovy的Inline表达式，提供对SQL语句中的=和IN的分片操作支持。InlineShardingStrategy只支持单分片键，对于简单的分片算法，可以通过简单的配置使用，从而避免繁琐的Java代码开发，如: tuser${user_id % 8} 表示t_user表按照user_id按8取模分成8个表，表名称为t_user_0到t_user_7。</p>
<ul>
<li><strong>HintShardingStrategy</strong></li>
</ul>
<p>通过Hint而非SQL解析的方式分片的策略。</p>
<ul>
<li><strong>NoneShardingStrategy</strong></li>
</ul>
<p>不分片的策略。</p>
<h2 id="6-2-分片配置"><a href="#6-2-分片配置" class="headerlink" title="6.2 分片配置"></a>6.2 分片配置</h2><p>标准分片配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 标准分片策略。--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;demoUserStandardStrategy&quot;</span> <span class="attr">class</span>=<span class="string">&quot;shard.strategy.DemoUserStandardStrategy&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sharding:standard-strategy</span> <span class="attr">id</span>=<span class="string">&quot;shardingDemoUserStandardStrategy&quot;</span></span></span><br><span class="line"><span class="tag">                            <span class="attr">precise-algorithm-ref</span>=<span class="string">&quot;demoUserStandardStrategy&quot;</span> <span class="attr">sharding-column</span>=<span class="string">&quot;id&quot;</span></span></span><br><span class="line"><span class="tag">                            <span class="attr">range-algorithm-ref</span>=<span class="string">&quot;&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>DemoUserStandardStrategy标准分片要实现 PreciseShardingAlgorithm 接口，doSharding的两个参数一个是所有数据源的cllection.另一个参数是执行SQL时传过来的分片的值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 根据ID取</span></span><br><span class="line"><span class="comment"> * 标准分片策略</span></span><br><span class="line"><span class="comment"> * 用于处理=和IN的分片</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yulonggao</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/1/31 14:35</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoUserStandardStrategy</span> <span class="keyword">implements</span> <span class="title">PreciseShardingAlgorithm</span>&lt;<span class="title">Long</span>&gt; </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doSharding</span><span class="params">(Collection&lt;String&gt; collection, PreciseShardingValue&lt;Long&gt; preciseShardingValue)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//这个里边有异常会被处理掉，然后导致拿不到分片。但出异常一般是业务代码写错了。</span></span><br><span class="line">        <span class="comment">//每条指定分片的操作都会调用此方法，如果是in 条件查询的话每个值会调用一次此方法，如果是批量插入也是每一条都要调用一次进行分片</span></span><br><span class="line">        log.info(<span class="string">&quot;DemoUserStandardStrategy_preciseShardingValue=&#123;&#125;&quot;</span>, preciseShardingValue);</span><br><span class="line">        Long suffix = preciseShardingValue.getValue() % <span class="number">4</span>;</span><br><span class="line">        log.info(<span class="string">&quot;suffix=&#123;&#125;&quot;</span>, suffix);</span><br><span class="line">        <span class="keyword">final</span> String targetDb = String.valueOf(Math.abs(suffix.intValue()));</span><br><span class="line">        String shardingValue = collection.stream().filter(p -&gt; p.endsWith(targetDb)).findFirst().get();</span><br><span class="line">        log.info(<span class="string">&quot;preciseShardingValue=&#123;&#125;,shardingValue=&#123;&#125;&quot;</span>, preciseShardingValue, shardingValue);</span><br><span class="line">        <span class="keyword">return</span> shardingValue;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>强制分片</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 强制路由分片策略--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;demoUserHintStrategy&quot;</span> <span class="attr">class</span>=<span class="string">&quot;shard.strategy.DemoUserHintStrategy&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">&lt;!-- 强制路由例子使用--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">sharding:hint-strategy</span> <span class="attr">id</span>=<span class="string">&quot;shardingDemoUserHintStrategy&quot;</span> <span class="attr">algorithm-ref</span>=<span class="string">&quot;demoUserHintStrategy&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>DemoUserHintStrategy 的Java 如下，强制分片要实现HintShardingAlgorithm接口。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DemoUserHint强制路由分片策略,其实可以共用，只是例子</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@author</span> yulonggao</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@date</span> 2019/1/31 14:35</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Slf4j</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DemoUserHintStrategy</span> <span class="keyword">implements</span> <span class="title">HintShardingAlgorithm</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> Collection&lt;String&gt; <span class="title">doSharding</span><span class="params">(Collection&lt;String&gt; availableTargetNames, ShardingValue shardingValue)</span> </span>&#123;</span><br><span class="line">        <span class="comment">//availableTargetNames 这个参数是所有的dataSource的集合，shardingValue是HintManager传过来的分片信息</span></span><br><span class="line">        log.info(<span class="string">&quot;DemoUserHintStrategy_availableTargetNames=&#123;&#125;&quot;</span>, availableTargetNames);</span><br><span class="line">        log.info(<span class="string">&quot;DemoUserHintStrategy_shardingValue=&#123;&#125;&quot;</span>, shardingValue);</span><br><span class="line">        ListShardingValue listShardingValue = (ListShardingValue) shardingValue;</span><br><span class="line">        Collection shardingValueList = listShardingValue.getValues();</span><br><span class="line">        <span class="comment">//因为调用的时候分片是直接传的 DataSource的名称，所以直接返回就可以了，如果传其它值则要加业务逻辑进行分片筛选</span></span><br><span class="line">        <span class="comment">//返回结果只能是availableTargetNames 里边所包含的</span></span><br><span class="line">        <span class="keyword">return</span> shardingValueList;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>生成分部式ID的配置，生成主键的类要实现KeyGenerator接口。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!—主键生成 --&gt;</span><br><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;keyId&quot;</span> <span class="attr">class</span>=<span class="string">&quot;shard.key.DefaultKeyGenerator&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p><img src="_v_images/20200604065002540_18818.png" alt="Sharding-JDBC配置"></p>
<h1 id="七、分布式事务"><a href="#七、分布式事务" class="headerlink" title="七、分布式事务"></a>七、分布式事务</h1><p>把下面这行代码配置在spring里，shardingTransaction.xml 是jar包里边带的。</p>
<p>文件的源码只有两行配置：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">&quot;transactionManager&quot;</span></span></span><br><span class="line"><span class="tag">      <span class="attr">class</span>=<span class="string">&quot;org.springframework.jdbc.datasource.DataSourceTransactionManager&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">&quot;dataSource&quot;</span> <span class="attr">ref</span>=<span class="string">&quot;shardingDataSource&quot;</span>&gt;</span><span class="tag">&lt;/<span class="name">property</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">tx:annotation-driven</span> <span class="attr">transaction-manager</span>=<span class="string">&quot;transactionManager&quot;</span>/&gt;</span></span><br><span class="line"><span class="comment">&lt;!-- 事务支持--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">import</span> <span class="attr">resource</span>=<span class="string">&quot;classpath:META-INF/shardingTransaction.xml&quot;</span>/&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用注解配置事务要同时使用ShardingTransactionType和Transactional两个注解。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 注意：<span class="doctag">@ShardingTransactionType</span>需要同Spring的<span class="doctag">@Transactional</span>配套使用，事务才会生效。</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> param</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@ShardingTransactionType(TransactionType.XA)</span></span><br><span class="line"><span class="meta">@Transactional(rollbackFor = Exception.class)</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">addParam</span><span class="params">(DemoParam param)</span> </span>&#123;</span><br><span class="line">log.info(<span class="string">&quot;addParam-param=&#123;&#125;&quot;</span>, param);</span><br><span class="line"><span class="keyword">return</span> demoParamDao.addParam(param);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="7-1-支持程度"><a href="#7-1-支持程度" class="headerlink" title="7.1 支持程度"></a>7.1 支持程度</h2><p>完全支持非跨库事务，例如：仅分表或分库但是路由的结果在单库中。</p>
<p>完全支持因逻辑异常导致的跨库事务。例如：同一事务中跨两个库更新，更新完毕后，抛出空指针，则两个库的内容都能回滚。</p>
<p>支持数据库字段约束造成的回滚。</p>
<h1 id="八、其他问题"><a href="#八、其他问题" class="headerlink" title="八、其他问题"></a>八、其他问题</h1><p>关于order by 排序，如果排序的字段不在查询结果中，生成的SQL也会被带上，但结果不返回给你。<br>不支持因网络、硬件异常导致的跨库事务。例如：同一事务中跨两个库更新，更新完毕后、未提交之前，第一个库死机，则只有第二个库数据提交。</p>
<p><img src="_v_images/20200604065318535_1841.png"></p>
<p>九、参考文档</p>
<ul>
<li><a target="_blank" rel="noopener" href="https://shardingsphere.apache.org/document/current/cn/manual/sharding-jdbc/usage/sharding/">https://shardingsphere.apache.org/document/current/cn/manual/sharding-jdbc/usage/sharding/</a></li>
<li><a target="_blank" rel="noopener" href="https://www.cnblogs.com/yixinjishu/p/10876071.html">https://www.cnblogs.com/yixinjishu/p/10876071.html</a></li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/06/28/architecture/Sharding-JDBC/" data-id="ckqg285tz002crcfpazq8ax79" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/06/28/architecture/shiro%E6%80%BB%E7%BB%93/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2021/06/28/architecture/Redis%E7%9F%A5%E8%AF%86/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/06/28/product/%E9%9C%80%E6%B1%82%E8%B0%83%E7%A0%94%E7%9A%84%E5%86%85%E5%AE%B9%E5%92%8C%E5%B7%A5%E4%BD%9C%E6%8C%87%E5%BC%95/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/06/28/product/%E9%93%81%E8%B7%AF6C%E4%B8%9A%E5%8A%A1%E7%BB%93%E6%9E%84/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/06/28/product/%E9%9C%80%E6%B1%82%E8%B0%83%E7%A0%94%E5%8F%8A%E5%88%86%E6%9E%90%E6%96%B9%E6%B3%95/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/06/28/product/%E6%B0%B4%E7%94%B5%E7%AB%99%E7%94%9F%E4%BA%A7%E8%BF%90%E8%A1%8C%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/06/28/product/%E6%B0%B4%E7%94%B5%E5%8E%82%E8%BF%90%E8%A1%8C%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>