<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>Hexo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="1. 第一章 基础框架搭建https:&#x2F;&#x2F;www.kancloud.cn&#x2F;mrbird&#x2F;spring-cloud&#x2F;1263687 JDK 1.8Spring Boot 2.1.6.RELEASESpring Cloud Greenwich.SR1Spring Cloud OAuth2Spring Cloud Security 1.1. 架构预览![系统架构图](https:&#x2F;&#x2F;s2.ax1x.co">
<meta property="og:type" content="article">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/2021/06/28/architecture/FEBS/%E6%90%AD%E5%BB%BA%E6%95%99%E7%A8%8B/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1. 第一章 基础框架搭建https:&#x2F;&#x2F;www.kancloud.cn&#x2F;mrbird&#x2F;spring-cloud&#x2F;1263687 JDK 1.8Spring Boot 2.1.6.RELEASESpring Cloud Greenwich.SR1Spring Cloud OAuth2Spring Cloud Security 1.1. 架构预览![系统架构图](https:&#x2F;&#x2F;s2.ax1x.co">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://s2.ax1x.com/2019/08/13/mpOPpR.png">
<meta property="og:image" content="https://s2.ax1x.com/2019/08/28/mHF6WF.png">
<meta property="og:image" content="https://s2.ax1x.com/2019/08/28/mH8sDP.png">
<meta property="article:published_time" content="2021-06-28T03:26:10.887Z">
<meta property="article:modified_time" content="2020-10-12T00:50:53.712Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://s2.ax1x.com/2019/08/13/mpOPpR.png">
  
    <link rel="alternate" href="/atom.xml" title="Hexo" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 5.4.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Hexo</a>
      </h1>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://example.com"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-architecture/FEBS/搭建教程" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2021/06/28/architecture/FEBS/%E6%90%AD%E5%BB%BA%E6%95%99%E7%A8%8B/" class="article-date">
  <time class="dt-published" datetime="2021-06-28T03:26:10.887Z" itemprop="datePublished">2021-06-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="1-第一章-基础框架搭建"><a href="#1-第一章-基础框架搭建" class="headerlink" title="1. 第一章 基础框架搭建"></a>1. 第一章 基础框架搭建</h1><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263687">https://www.kancloud.cn/mrbird/spring-cloud/1263687</a></p>
<p>JDK 1.8<br>Spring Boot 2.1.6.RELEASE<br>Spring Cloud Greenwich.SR1<br>Spring Cloud OAuth2<br>Spring Cloud Security</p>
<h2 id="1-1-架构预览"><a href="#1-1-架构预览" class="headerlink" title="1.1. 架构预览"></a>1.1. 架构预览</h2><p>![系统架构图](<a target="_blank" rel="noopener" href="https://s2.ax1x.com/2019/08/31/mxMgW8.png">https://s2.ax1x.com/2019/08/31/mxMgW8.png</a> =1024x)</p>
<p>FEBS-Register：微服务注册中心，用于统一控制各个微服务实例的注册与发现；<br>FEBS-Gateway：微服务网关，统一处理外部请求，是客户端和众多微服务连接的桥梁；<br>FEBS-Auth：微服务认证服务器，用于令牌（Token）生成和令牌校验，是整个权限系统的核心所在；<br>FEBS-Server-System：微服务提供者（资源服务器）A，对外提供系统模块的CRUD服务；<br>FEBS-Server-Test：微服务提供者（资源服务器）B。</p>
<h2 id="1-2-搭建微服务注册中心"><a href="#1-2-搭建微服务注册中心" class="headerlink" title="1.2. 搭建微服务注册中心"></a>1.2. 搭建微服务注册中心</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263688">https://www.kancloud.cn/mrbird/spring-cloud/1263688</a></p>
<p>在这一节中，我们先使用Eureka构建微服务注册中心（Eureka服务端），因为Eureka较为简单，无须启动第三方服务，只需要引入相关依赖即可。</p>
<h2 id="1-3-搭建认证服务器"><a href="#1-3-搭建认证服务器" class="headerlink" title="1.3. 搭建认证服务器"></a>1.3. 搭建认证服务器</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263689">https://www.kancloud.cn/mrbird/spring-cloud/1263689</a></p>
<p>借助Spring Cloud OAuth和Spring Cloud Security搭建一个统一给微服务发放访问令牌的认证服务器febs-auth。</p>
<h2 id="1-4-搭建微服务网关"><a href="#1-4-搭建微服务网关" class="headerlink" title="1.4. 搭建微服务网关"></a>1.4. 搭建微服务网关</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263690">https://www.kancloud.cn/mrbird/spring-cloud/1263690</a></p>
<p>在微服务的架构中，服务网关就是一个介于客户端与服务端之间的中间层。在这种情况下，客户端只需要跟服务网关交互，无需调用具体的微服务接口。这样的好处在于，客户端可以降低复杂性，无需关注具体是哪个微服务在提供服务。这一节我们将使用Spring Cloud Zuul搭建微服务网关febs-gateway。</p>
<h2 id="1-5-搭建资源服务器"><a href="#1-5-搭建资源服务器" class="headerlink" title="1.5. 搭建资源服务器"></a>1.5. 搭建资源服务器</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1420720">https://www.kancloud.cn/mrbird/spring-cloud/1420720</a></p>
<h1 id="2-架构完善"><a href="#2-架构完善" class="headerlink" title="2. 架构完善"></a>2. 架构完善</h1><p>这一章主要对上一节搭建的基础框架进行完善，解决微服务权限系统常见的问题。</p>
<h2 id="2-1-参数配置化"><a href="#2-1-参数配置化" class="headerlink" title="2.1. 参数配置化"></a>2.1. 参数配置化</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263694">https://www.kancloud.cn/mrbird/spring-cloud/1263694</a></p>
<p><code>spring-boot-configuration-processor</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span><br><span class="line"><span class="meta">@SpringBootConfiguration</span></span><br><span class="line"><span class="meta">@PropertySource(value = &#123;&quot;classpath:febs-auth.properties&quot;&#125;)</span></span><br><span class="line"><span class="meta">@ConfigurationProperties(prefix = &quot;febs.auth&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FebsAuthProperties</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> FebsClientsProperties[] clients = &#123;&#125;;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> accessTokenValiditySeconds = <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> refreshTokenValiditySeconds = <span class="number">60</span> * <span class="number">60</span> * <span class="number">24</span> * <span class="number">7</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">febs.auth.accessTokenValiditySeconds</span>=<span class="number">86400</span></span><br><span class="line"><span class="attr">febs.auth.refreshTokenValiditySeconds</span>=<span class="number">604800</span></span><br><span class="line"></span><br><span class="line">febs.auth.clients<span class="section">[0]</span>.<span class="attr">client</span>=febs</span><br><span class="line">febs.auth.clients<span class="section">[0]</span>.<span class="attr">secret</span>=<span class="number">123456</span></span><br><span class="line">febs.auth.clients<span class="section">[0]</span>.<span class="attr">grantType</span>=password,authorization_code,refresh_token</span><br><span class="line">febs.auth.clients<span class="section">[0]</span>.<span class="attr">scope</span>=all</span><br></pre></td></tr></table></figure>

<h2 id="2-2-异常处理"><a href="#2-2-异常处理" class="headerlink" title="2.2. 异常处理"></a>2.2. 异常处理</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263695">https://www.kancloud.cn/mrbird/spring-cloud/1263695</a></p>
<h2 id="2-3-Feign的使用"><a href="#2-3-Feign的使用" class="headerlink" title="2.3. Feign的使用"></a>2.3. Feign的使用</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263696">https://www.kancloud.cn/mrbird/spring-cloud/1263696</a></p>
<p>微服务之间服务的调用可以借助Spring Cloud Feign来完成，Spring Cloud Feign内部整合了Spring Cloud Ribbon和Spring Cloud Hystrix，所以它具有客户端负载均衡和服务容错的功能。</p>
<p><code>spring-cloud-starter-openfeign</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableFeignClients</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FebsServerTestApplication</span> </span>&#123;</span><br><span class="line">    ......</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FeignClient(value = &quot;FEBS-Server-System&quot;, contextId = &quot;helloServiceClient&quot;, fallbackFactory = HelloServiceFallback.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">IHelloService</span> </span>&#123;</span><br><span class="line">    <span class="meta">@GetMapping(&quot;hello&quot;)</span></span><br><span class="line">    <span class="function">String <span class="title">hello</span><span class="params">(<span class="meta">@RequestParam(&quot;name&quot;)</span> String name)</span></span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="2-4-微服务防护"><a href="#2-4-微服务防护" class="headerlink" title="2.4. 微服务防护"></a>2.4. 微服务防护</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263697">https://www.kancloud.cn/mrbird/spring-cloud/1263697</a></p>
<ul>
<li>自定义Zuul过滤器<br>解决这个问题的大致思路是：在网关转发请求前，请求头部加入网关信息，然后在处理请求的微服务模块里定义全局拦截器，校验请求头部的网关信息，这样就能避免客户端直接访问微服务了。<br>在自定义Zuul过滤器前，我们先来简单了解下Zuul的核心过滤器。Zuul中默认定义了4种不同生命周期的过滤器类型。<ul>
<li>PRE：PRE过滤器用于将请求路径与配置的路由规则进行匹配，以找到需要转发的目标地址，并做一些前置加工，比如请求的校验等；</li>
<li>ROUTING：ROUTING过滤器用于将外部请求转发到具体服务实例上去；</li>
<li>POST：POST过滤器用于将微服务的响应信息返回到客户端，这个过程种可以对返回数据进行加工处理；</li>
<li>ERROR：上述的过程发生异常后将调用ERROR过滤器。ERROR过滤器捕获到异常后需要将异常信息返回给客户端，所以最终还是会调用POST过滤器。</li>
</ul>
</li>
</ul>
<h2 id="2-5-跨域处理"><a href="#2-5-跨域处理" class="headerlink" title="2.5. 跨域处理"></a>2.5. 跨域处理</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263698">https://www.kancloud.cn/mrbird/spring-cloud/1263698</a></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FebsGateWayCorsConfigure</span> </span>&#123;</span><br><span class="line">    <span class="meta">@Bean</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> CorsFilter <span class="title">corsFilter</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">final</span> UrlBasedCorsConfigurationSource source = <span class="keyword">new</span> UrlBasedCorsConfigurationSource();</span><br><span class="line">        <span class="keyword">final</span> CorsConfiguration corsConfiguration = <span class="keyword">new</span> CorsConfiguration();</span><br><span class="line">        <span class="comment">// 允许cookie跨域</span></span><br><span class="line">        corsConfiguration.setAllowCredentials(<span class="keyword">true</span>);</span><br><span class="line">        <span class="comment">// 请求头部允许携带任何内容</span></span><br><span class="line">        corsConfiguration.addAllowedHeader(CorsConfiguration.ALL);</span><br><span class="line">        <span class="comment">// 允许任何来源</span></span><br><span class="line">        corsConfiguration.addAllowedOrigin(CorsConfiguration.ALL);</span><br><span class="line">        <span class="comment">// 允许任何HTTP方法</span></span><br><span class="line">        corsConfiguration.addAllowedMethod(CorsConfiguration.ALL);</span><br><span class="line">        source.registerCorsConfiguration(<span class="string">&quot;/**&quot;</span>, corsConfiguration);</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> CorsFilter(source);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="3-完善登录流程"><a href="#3-完善登录流程" class="headerlink" title="3. 完善登录流程"></a>3. 完善登录流程</h1><h2 id="3-1-表结构设计"><a href="#3-1-表结构设计" class="headerlink" title="3.1. 表结构设计"></a>3.1. 表结构设计</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263701">https://www.kancloud.cn/mrbird/spring-cloud/1263701</a></p>
<p><img src="https://s2.ax1x.com/2019/08/13/mpOPpR.png" alt="用户-角色-权限"></p>
<h2 id="3-2-完善登录"><a href="#3-2-完善登录" class="headerlink" title="3.2. 完善登录"></a>3.2. 完善登录</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263702">https://www.kancloud.cn/mrbird/spring-cloud/1263702</a></p>
<p><code>mybatis-plus-boot-starter</code><br><code>dynamic-datasource-spring-boot-starter</code> MyBatis Plus多数据源依赖<br><code>mysql-connector-java</code></p>
<h2 id="3-3-整合图形验证码"><a href="#3-3-整合图形验证码" class="headerlink" title="3.3. 整合图形验证码"></a>3.3. 整合图形验证码</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263703">https://www.kancloud.cn/mrbird/spring-cloud/1263703</a></p>
<p>Spring Security本质是一长串的过滤器链，处理用户名密码登录的过滤器为<code>UsernamePasswordAuthenticationFilter</code>，要集成图形验证码校验很简单，只需要在<code>UsernamePasswordAuthenticationFilter</code>过滤器前添加图形验证码校验过滤器即可。</p>
<p>我们通常会把验证码存储在Redis中，并设置失效时间。<br>Spring Boot 2.0后推荐使用Lettuce来代替Jedis，Lettuce基于Netty异步，拥有更好的性能。</p>
<p>生成图形验证码可以借助GitHub的一个开源项目<code>https://github.com/whvcse/EasyCaptcha</code>，其提供了较为丰富的验证码配置可供选择。<br>在febs-auth的pom里引入该依赖：<br><dependency><br>    <groupId>com.github.whvcse</groupId><br>    <artifactId>easy-captcha</artifactId><br>    <version>1.6.2</version><br></dependency></p>
<p>在前后端不分离的架构下，我们通过浏览器传输的jsessionid来和验证码图片一一对应，但前后的分离的模式下，客户端发送的请求并没有携带jsessionid（因为不再基于Session），所以我们需要客户端在发送获取验证码请求的时候，携带一个key（比如按一定算法生成的随机字符串，模拟jsessionid）来和验证码一一对应。于是我们在create里一开始就从请求中获取key值，然后根据验证码配置文件生成验证码，并将验证码字符保存到了Redis中（Redis Key为febs.captcha. + 客户端上送的key值，有效时间为配置文件定义的120秒），并将验证码图片以流的形式返回给客户端。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ValidateCodeFilter</span> <span class="keyword">extends</span> <span class="title">OncePerRequestFilter</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> ValidateCodeService validateCodeService;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">doFilterInternal</span><span class="params">(HttpServletRequest httpServletRequest, HttpServletResponse httpServletResponse, FilterChain filterChain)</span> <span class="keyword">throws</span> ServletException, IOException </span>&#123;</span><br><span class="line">    <span class="comment">// 校验验证码</span></span><br></pre></td></tr></table></figure>

<h2 id="3-4-Sentinel验证码限流"><a href="#3-4-Sentinel验证码限流" class="headerlink" title="3.4. Sentinel验证码限流"></a>3.4. Sentinel验证码限流</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263704">https://www.kancloud.cn/mrbird/spring-cloud/1263704</a></p>
<p>因为我们的验证码服务是免认证的，所以只要知道了地址就可以频繁的去获取验证码，这无形之中给服务器增加了很大的压力，甚至可能导致服务器宕机。<br>为了解决这个问题，我们可以在网关处整合阿里巴巴开源的Sentinel流量哨兵来限制验证码的获取频率。</p>
<p><code>com.alibaba.csp:sentinel-zuul-adapter:1.6.3</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">FebsGatewaySentinelFilter</span> </span>&#123;</span><br><span class="line">....</span><br><span class="line">    <span class="meta">@PostConstruct</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doInit</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        initGatewayRules();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 定义验证码请求限流，限流规则：</span></span><br><span class="line"><span class="comment">     *  60秒内同一个IP，同一个 key最多访问 10次</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">initGatewayRules</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        Set&lt;ApiDefinition&gt; definitions = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line">        Set&lt;ApiPredicateItem&gt; predicateItems = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        predicateItems.add(<span class="keyword">new</span> ApiPathPredicateItem().setPattern(<span class="string">&quot;/auth/captcha&quot;</span>));</span><br><span class="line">        ApiDefinition definition = <span class="keyword">new</span> ApiDefinition(<span class="string">&quot;captcha&quot;</span>)</span><br><span class="line">                .setPredicateItems(predicateItems);</span><br><span class="line">        definitions.add(definition);</span><br><span class="line">        GatewayApiDefinitionManager.loadApiDefinitions(definitions);</span><br><span class="line"></span><br><span class="line">        Set&lt;GatewayFlowRule&gt; rules = <span class="keyword">new</span> HashSet&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        rules.add(<span class="keyword">new</span> GatewayFlowRule(<span class="string">&quot;captcha&quot;</span>)</span><br><span class="line">                .setResourceMode(SentinelGatewayConstants.RESOURCE_MODE_CUSTOM_API_NAME)</span><br><span class="line">                .setParamItem(</span><br><span class="line">                        <span class="keyword">new</span> GatewayParamFlowItem()</span><br><span class="line">                                .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_URL_PARAM)</span><br><span class="line">                                .setFieldName(<span class="string">&quot;key&quot;</span>)</span><br><span class="line">                                .setMatchStrategy(SentinelGatewayConstants.PARAM_MATCH_STRATEGY_EXACT)</span><br><span class="line">                                .setParseStrategy(SentinelGatewayConstants.PARAM_PARSE_STRATEGY_CLIENT_IP)</span><br><span class="line">                )</span><br><span class="line">                .setCount(<span class="number">10</span>)</span><br><span class="line">                .setIntervalSec(<span class="number">60</span>)</span><br><span class="line">        );</span><br><span class="line">        GatewayRuleManager.loadRules(rules);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="4-整合Swagger"><a href="#4-整合Swagger" class="headerlink" title="4. 整合Swagger"></a>4. 整合Swagger</h1><h2 id="4-1-完善febs-server-system"><a href="#4-1-完善febs-server-system" class="headerlink" title="4.1. 完善febs-server-system"></a>4.1. 完善febs-server-system</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263707">https://www.kancloud.cn/mrbird/spring-cloud/1263707</a></p>
<p>因为febs-server-system模块负责用户管理、角色管理、菜单管理、部门管理等模块的增删改查，所以这章将演示如何在febs-server-system模块里集成swagger，其他微服务系统要集成swagger照猫画虎就行了。</p>
<ul>
<li>集成MyBatis Plus</li>
<li>配置p6spy<br>p6spy用于在控制台中打印MyBatis执行的SQL。</li>
<li>用户管理模块增删改查</li>
<li>暴露服务</li>
<li>数据校验</li>
<li>PostMan测试</li>
</ul>
<h2 id="4-2-接入Swagger"><a href="#4-2-接入Swagger" class="headerlink" title="4.2. 接入Swagger"></a>4.2. 接入Swagger</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263708">https://www.kancloud.cn/mrbird/spring-cloud/1263708</a></p>
<p><code>io.springfox:springfox-swagger2:2.9.2</code><br><code>io.springfox:springfox-swagger-ui:2.9.2</code></p>
<h2 id="4-3-Swagger-OAuth2认证"><a href="#4-3-Swagger-OAuth2认证" class="headerlink" title="4.3. Swagger OAuth2认证"></a>4.3. Swagger OAuth2认证</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263709">https://www.kancloud.cn/mrbird/spring-cloud/1263709</a></p>
<p>我们在febs-auth模块里配置一个新的Client，专门用于Swagger令牌发放。在febs-auth模块的febs-auth.properties配置文件里添加如下配置:</p>
<figure class="highlight ini"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">febs.auth.clients<span class="section">[1]</span>.<span class="attr">client</span>=swagger</span><br><span class="line">febs.auth.clients<span class="section">[1]</span>.<span class="attr">secret</span>=<span class="number">123456</span></span><br><span class="line">febs.auth.clients<span class="section">[1]</span>.<span class="attr">grantType</span>=password</span><br><span class="line">febs.auth.clients<span class="section">[1]</span>.<span class="attr">scope</span>=test</span><br></pre></td></tr></table></figure>

<h1 id="5-整合第三方服务"><a href="#5-整合第三方服务" class="headerlink" title="5. 整合第三方服务"></a>5. 整合第三方服务</h1><h2 id="5-1-整合Spring-Boot-Admin"><a href="#5-1-整合Spring-Boot-Admin" class="headerlink" title="5.1. 整合Spring Boot Admin"></a>5.1. 整合Spring Boot Admin</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263712">https://www.kancloud.cn/mrbird/spring-cloud/1263712</a></p>
<p>Spring Boot Admin通过<code>spring-boot-starter-actuator</code>提供的REST接口实现了图形化的监控界面，包括应用的配置信息、Beans信息、环境属性、线程信息、JVM状况等。<br>Spring Boot Admin分为服务端和客户端。客户端通过HTTP向服务端提供自身信息，服务端收集这些信息并以图形化界面的方式呈现。下面，Spring Boot Admin客户端简称为SBA客户端，Spring Boot Admin服务端简称为SBA服务端。<br>整合Spring Boot Admin后，我们的系统架构如下所示:</p>
<p>![系统架构图](<a target="_blank" rel="noopener" href="https://s2.ax1x.com/2019/08/31/mxQHHA.png">https://s2.ax1x.com/2019/08/31/mxQHHA.png</a> =1024x)</p>
<p><code>de.codecentric:spring-boot-admin-server:2.1.6</code><br><code>de.codecentric:spring-boot-admin-server-ui:2.1.6</code></p>
<h2 id="5-2-Sleuth-Zipkin链路追踪"><a href="#5-2-Sleuth-Zipkin链路追踪" class="headerlink" title="5.2. Sleuth Zipkin链路追踪"></a>5.2. Sleuth Zipkin链路追踪</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263713">https://www.kancloud.cn/mrbird/spring-cloud/1263713</a></p>
<p>一个复杂的业务流程通常会被拆分多个微服务系统来完成，微服务间通过Feign来通信。当业务流程足够复杂时，一个完整的HTTP请求调用链一般会经过多个微服务系统，要通过日志来跟踪一整个调用链变得不再那么简单。我们可以通过Spring Cloud Sleuth来解决这个问题。</p>
<ul>
<li>整合Spring Cloud Sleuth<br><code>org.springframework.cloud:spring-cloud-starter-sleuth</code></li>
</ul>
<p>从日志里捞取traceId并追踪请求链路。借助zipkin实现使用图形化界面的方式追踪请求链路。</p>
<ul>
<li>整合Zipkin<br>在整合Zipkin之前，我们需要先搭建RabbitMQ。RabbitMQ用于收集Sleuth提供的追踪信息，然后Zipkin Server从RabbitMQ里获取，这样可以提升性能。</li>
</ul>
<h2 id="5-3-logback日志打印"><a href="#5-3-logback日志打印" class="headerlink" title="5.3. logback日志打印"></a>5.3. logback日志打印</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263714">https://www.kancloud.cn/mrbird/spring-cloud/1263714</a></p>
<h2 id="5-4-ELK日志收集"><a href="#5-4-ELK日志收集" class="headerlink" title="5.4. ELK日志收集"></a>5.4. ELK日志收集</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263715">https://www.kancloud.cn/mrbird/spring-cloud/1263715</a></p>
<ul>
<li>搭建ELK环境</li>
<li>修改微服务日志配置<br>我们分别在febs-auth、febs-gateway和febs-server模块的pom里引入<code>Logstash</code>依赖 <code>net.logstash.logback:logstash-logback-encoder:6.1</code>， 并增加logback-spring.xml 配置：</li>
</ul>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!--输出到 logstash的 appender--&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">appender</span> <span class="attr">name</span>=<span class="string">&quot;logstash&quot;</span> <span class="attr">class</span>=<span class="string">&quot;net.logstash.logback.appender.LogstashTcpSocketAppender&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">destination</span>&gt;</span>192.168.33.10:4560<span class="tag">&lt;/<span class="name">destination</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">encoder</span> <span class="attr">charset</span>=<span class="string">&quot;UTF-8&quot;</span> <span class="attr">class</span>=<span class="string">&quot;net.logstash.logback.encoder.LogstashEncoder&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">appender</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">root</span> <span class="attr">level</span>=<span class="string">&quot;info&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">appender-ref</span> <span class="attr">ref</span>=<span class="string">&quot;logstash&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">root</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="6-前端系统介绍"><a href="#6-前端系统介绍" class="headerlink" title="6. 前端系统介绍"></a>6. 前端系统介绍</h1><p>FEBS Cloud的前端FEBS Cloud Web采用 vue-element-admin，它是一款基于 vue 和 element-ui实现的后台管理系统模板。</p>
<h2 id="6-1-封装Axios"><a href="#6-1-封装Axios" class="headerlink" title="6.1. 封装Axios"></a>6.1. 封装Axios</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263718">https://www.kancloud.cn/mrbird/spring-cloud/1263718</a></p>
<h2 id="6-2-Vue导航守卫"><a href="#6-2-Vue导航守卫" class="headerlink" title="6.2. Vue导航守卫"></a>6.2. Vue导航守卫</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263719">https://www.kancloud.cn/mrbird/spring-cloud/1263719</a></p>
<h2 id="6-3-动态路由构建"><a href="#6-3-动态路由构建" class="headerlink" title="6.3. 动态路由构建"></a>6.3. 动态路由构建</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263720">https://www.kancloud.cn/mrbird/spring-cloud/1263720</a></p>
<h2 id="6-4-处理用户登录"><a href="#6-4-处理用户登录" class="headerlink" title="6.4. 处理用户登录"></a>6.4. 处理用户登录</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263721">https://www.kancloud.cn/mrbird/spring-cloud/1263721</a></p>
<p><img src="https://s2.ax1x.com/2019/08/28/mHF6WF.png" alt="登录流程"></p>
<h2 id="6-5-处理令牌刷新"><a href="#6-5-处理令牌刷新" class="headerlink" title="6.5. 处理令牌刷新"></a>6.5. 处理令牌刷新</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263722">https://www.kancloud.cn/mrbird/spring-cloud/1263722</a></p>
<p>我们在febs-auth定义的令牌有效时间为86400秒（即24小时），过了24小时候令牌就失效了。假如令牌即将要失效时，用户还在使用系统，那么用户的某个操作可能进行了一半时，系统突然弹出登录过期提示，非常影响用户体验。<br>要解决上面的问题，我们可以在令牌将要失效时，判断用户是否还在使用系统，如果是的话，我们可以偷偷地通过刷新令牌来获取一个新的访问令牌，存储到浏览器内存中。这样就可以在用户无感知的情况下，“延长”访问令牌的有效时间。<br>因为我们系统的请求都是通过6.1节封装的Axios对象来完成的，并且我们在request.js里配置了请求拦截，所以我们刷新令牌的动作也可以在请求拦截器里完成，大致步骤如下图所示：</p>
<p><img src="https://s2.ax1x.com/2019/08/28/mH8sDP.png" alt="处理令牌刷新"></p>
<h2 id="6-6-自定义Vue权限指令"><a href="#6-6-自定义Vue权限指令" class="headerlink" title="6.6. 自定义Vue权限指令"></a>6.6. 自定义Vue权限指令</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263723">https://www.kancloud.cn/mrbird/spring-cloud/1263723</a></p>
<p><code>&lt;button v-has-permission=&quot;[&#39;user:add&#39;]&quot;&gt;新增用户&lt;/button&gt;</code></p>
<h1 id="7-微服务部署"><a href="#7-微服务部署" class="headerlink" title="7. 微服务部署"></a>7. 微服务部署</h1><h2 id="7-1-微服务Docker化"><a href="#7-1-微服务Docker化" class="headerlink" title="7.1. 微服务Docker化"></a>7.1. 微服务Docker化</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263726">https://www.kancloud.cn/mrbird/spring-cloud/1263726</a></p>
<h2 id="7-2-使用Docker-Compose部署"><a href="#7-2-使用Docker-Compose部署" class="headerlink" title="7.2. 使用Docker Compose部署"></a>7.2. 使用Docker Compose部署</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263727">https://www.kancloud.cn/mrbird/spring-cloud/1263727</a></p>
<h1 id="8-微服务进阶"><a href="#8-微服务进阶" class="headerlink" title="8. 微服务进阶"></a>8. 微服务进阶</h1><h2 id="8-1-令牌存储策略"><a href="#8-1-令牌存储策略" class="headerlink" title="8.1. 令牌存储策略"></a>8.1. 令牌存储策略</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1277531">https://www.kancloud.cn/mrbird/spring-cloud/1277531</a></p>
<ul>
<li><p>RedisTokenStore<br>在第一章搭建认证服务器的时候，我们使用的是RedisTokenStore令牌存储策略。使用这种策略时，用户的access_token将存储到Redis中，退出登录后，Redis中存储的令牌也会被清除。<br>除了这种令牌存储策略外，Spring还提供了InMemoryTokenStore、JdbcTokenStore和JwtTokenStore三种存储策略：</p>
</li>
<li><p>InMemoryTokenStore<br>该策略将令牌存储到内存中，优点就是无需依赖第三方存储，对于开发小型服务是不错的选择；缺点是认证服务器故障重启后，之前存储的令牌就丢失。</p>
</li>
<li><p>JdbcTokenStore<br>顾名思义，该策略使用数据库来存储令牌。在使用这种策略之前，我们需要先准备好库表。Spring Security OAuth仓库可以找到相应的脚本，只需要使用到oauth_access_token和oauth_refresh_token数据表。</p>
</li>
<li><p>JwtTokenStore<br>前面三种存储策略生成的令牌都是使用UUID生成的无意义字符串，我们也可以使用JwtTokenStore生成JWT格式令牌。<br>在febs-auth模块下认证服务器配置类FebsAuthorizationServerConfigure中配置JwtTokenStore。</p>
</li>
</ul>
<h2 id="8-2-使用Cloud-Gateway搭建网关"><a href="#8-2-使用Cloud-Gateway搭建网关" class="headerlink" title="8.2. 使用Cloud Gateway搭建网关"></a>8.2. 使用Cloud Gateway搭建网关</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1263731">https://www.kancloud.cn/mrbird/spring-cloud/1263731</a></p>
<p>这一节，我们将使用Spring Cloud Gateway构建一个全新的微服务网关，代替之前通过Spring Cloud Zuul构建的微服务网关。和Zuul相比，Spring Cloud Gateway具有如下优势：<br>基于Reactor模型的WebFlux构建，运行在Netty上，具有更好的性能；<br>可拓展性高，内置了非常丰富的转发规则，除此之外，我们也可以定义自己的转发规则。<br>对于WebFlux不熟悉的同学可以在学完本节后阅读我的博文：<a target="_blank" rel="noopener" href="https://mrbird.cc/tags/WebFlux/%E3%80%82">https://mrbird.cc/tags/WebFlux/。</a></p>
<p><code>org.springframework.cloud:spring-cloud-starter-gateway</code></p>
<ul>
<li>转发规则<br>Spring Cloud Gateway两大核心概念为：谓词工厂和过滤器工厂，谓词工厂用于定义转发规则，过滤器工厂用于修改请求和响应。Spring Cloud Gateway内置的谓词工厂和过滤器工厂可以参考：<a target="_blank" rel="noopener" href="https://cloud.spring.io/spring-cloud-gateway/reference/html/#gateway-request-predicates-factories%E5%92%8Chttps://cloud.spring.io/spring-cloud-gateway/reference/html/#gatewayfilter-factories%E3%80%82">https://cloud.spring.io/spring-cloud-gateway/reference/html/#gateway-request-predicates-factories和https://cloud.spring.io/spring-cloud-gateway/reference/html/#gatewayfilter-factories。</a></li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">gateway:</span></span><br><span class="line">      <span class="attr">routes:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">FEBS-Auth</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://FEBS-Auth</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/auth/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">FEBS-Server-System</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://FEBS-Server-System</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/system/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">id:</span> <span class="string">FEBS-Server-test</span></span><br><span class="line">          <span class="attr">uri:</span> <span class="string">lb://FEBS-Server-Test</span></span><br><span class="line">          <span class="attr">predicates:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">Path=/test/**</span></span><br><span class="line">          <span class="attr">filters:</span></span><br><span class="line">            <span class="bullet">-</span> <span class="string">StripPrefix=1</span></span><br></pre></td></tr></table></figure>

<ul>
<li>定义全局过滤器</li>
</ul>
<h2 id="8-3-使用Alibaba-Nacos注册中心"><a href="#8-3-使用Alibaba-Nacos注册中心" class="headerlink" title="8.3. 使用Alibaba Nacos注册中心"></a>8.3. 使用Alibaba Nacos注册中心</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1271133">https://www.kancloud.cn/mrbird/spring-cloud/1271133</a></p>
<h2 id="8-4-使用Alibaba-Nacos存储配置"><a href="#8-4-使用Alibaba-Nacos存储配置" class="headerlink" title="8.4. 使用Alibaba Nacos存储配置"></a>8.4. 使用Alibaba Nacos存储配置</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1289434">https://www.kancloud.cn/mrbird/spring-cloud/1289434</a></p>
<p>Spring Cloud Alibaba Nacos不但可以用于搭建微服务注册中心，还可以统一管理微服务配置，类似于Spring Cloud Config。</p>
<ul>
<li>Nacos数据持久化<br>Nacos支持使用MySQL进行数据持久化。</li>
<li>使用Nacos管理配置<br>增加依赖<code>org.springframework.cloud:spring-cloud-starter-alibaba-nacos-config</code><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">application:</span></span><br><span class="line">    <span class="attr">name:</span> <span class="string">FEBS-Auth</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">nacos:</span></span><br><span class="line">      <span class="attr">discovery:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">$&#123;nacos.url&#125;:8001</span></span><br><span class="line">      <span class="attr">config:</span></span><br><span class="line">        <span class="attr">server-addr:</span> <span class="string">$&#123;nacos.url&#125;:8001</span></span><br><span class="line">        <span class="attr">group:</span> <span class="string">DEFAULT_GROUP</span></span><br><span class="line">        <span class="attr">prefix:</span> <span class="string">febs-auth</span></span><br><span class="line">        <span class="attr">file-extension:</span> <span class="string">yaml</span></span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="8-5-接入Prometheus-Grafana"><a href="#8-5-接入Prometheus-Grafana" class="headerlink" title="8.5. 接入Prometheus + Grafana"></a>8.5. 接入Prometheus + Grafana</h2><p>这节的目的是搭建一个多维度监控微服务的可视化平台，包括Docker容器监控、MySQL监控、Redis监控和微服务JVM监控等，并且在必要的情况下可以发送预警邮件。<br>这节主要用到的组件有Prometheus、Grafana、alertmanager、node_exporter、mysql_exporter、redis_exporter、cadvisor。各自作用如下所示：</p>
<ol>
<li>Prometheus：获取、存储监控数据，供第三方查询；</li>
<li>Grafana：提供Web页面，从Prometheus获取监控数据可视化展示；</li>
<li>alertmanager：定义预警规则，发送预警信息；</li>
<li>node_exporter：收集微服务端点监控数据；</li>
<li>mysql_exporter：收集MySQL数据库监控数据；</li>
<li>redis_exporter：收集Redis监控数据；</li>
<li>cadvisor：收集Docker容器监控数据。</li>
</ol>
<h2 id="8-6-整合skywalking分布式追踪"><a href="#8-6-整合skywalking分布式追踪" class="headerlink" title="8.6. 整合skywalking分布式追踪"></a>8.6. 整合skywalking分布式追踪</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1337996">https://www.kancloud.cn/mrbird/spring-cloud/1337996</a></p>
<p>Skywalking是由国人吴晟开发的一款分布式追踪软件，后面成功孵化为Apache的顶级项目。Skywalking主要包括了分布式追踪、性能指标分析、应用和服务依赖分析等功能，使用体验后个人感觉比zipkin更为直观，是替代zipkin的一个不错的选择。<br>Skywalking的主要结构图如下所示:<br>![](<a target="_blank" rel="noopener" href="https://s2.ax1x.com/2019/10/20/Kutat0.png">https://s2.ax1x.com/2019/10/20/Kutat0.png</a> =1024x)</p>
<p>从上图可以看出Skywalking主要分为四个模块：agent、collector、webapp-ui和storage。我们可以使用Skywalking agent探针无侵入地接入Spring Cloud应用，然后通过HTTP或者GRPC将应用数据采集到collector收集器。collector中的数据存储与storage，支持MySQL、H2、Elasticsearch等存储，最终这些数据集中在webapp-ui以图形化的方式呈现。</p>
<h2 id="8-7-升级到Hoxton-RELEASE"><a href="#8-7-升级到Hoxton-RELEASE" class="headerlink" title="8.7. 升级到Hoxton.RELEASE"></a>8.7. 升级到Hoxton.RELEASE</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1411735">https://www.kancloud.cn/mrbird/spring-cloud/1411735</a></p>
<h1 id="9-K8S集群部署"><a href="#9-K8S集群部署" class="headerlink" title="9. K8S集群部署"></a>9. K8S集群部署</h1><h2 id="9-1-集群环境准备"><a href="#9-1-集群环境准备" class="headerlink" title="9.1. 集群环境准备"></a>9.1. 集群环境准备</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1426915">https://www.kancloud.cn/mrbird/spring-cloud/1426915</a></p>
<p>这一章节，我们的目标是通过Kubernetes（下面简称k8s，因为k和s之间有8个字符，所以俗称k8s）部署一个高可用的FEBS Cloud微服务权限系统，所以在此之前你需要掌握Kubernetes的基本知识。如果您还未曾接触过Kubernetes，可以通过我的博客<a target="_blank" rel="noopener" href="https://mrbird.cc/tags/Kubernetes/%E6%88%96%E8%80%85%E8%B4%AD%E4%B9%B0%E3%80%8AKubernetes%E6%9D%83%E5%A8%81%E6%8C%87%E5%8D%97(%E7%AC%AC4%E7%89%88)%E3%80%8B%E4%B9%A6%E7%B1%8D%E5%AD%A6%E4%B9%A0%E3%80%82">https://mrbird.cc/tags/Kubernetes/或者购买《Kubernetes权威指南(第4版)》书籍学习。</a></p>
<h2 id="9-2-安装第三方服务"><a href="#9-2-安装第三方服务" class="headerlink" title="9.2. 安装第三方服务"></a>9.2. 安装第三方服务</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1426916">https://www.kancloud.cn/mrbird/spring-cloud/1426916</a></p>
<p>这一节我们需要安装的内容较多，包括Docker、Docker Compose、MySQL、Redis、ELK等软件。</p>
<h2 id="9-3-Kubeadm搭建K8S-1-16-2集群"><a href="#9-3-Kubeadm搭建K8S-1-16-2集群" class="headerlink" title="9.3. Kubeadm搭建K8S 1.16.2集群"></a>9.3. Kubeadm搭建K8S 1.16.2集群</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1426917">https://www.kancloud.cn/mrbird/spring-cloud/1426917</a></p>
<p>Kubernetes从1.4版本开始后就引入了kubeadm用于简化集群搭建的过程，在Kubernetes 1.13版本中，kubeadm工具进入GA阶段，可用于生产环境Kubernetes集群搭建。本节将使用Kubeadm搭建Kubernetes1.16.2集群，宿主机使用9.1里搭建的master、node1、node2、node3四台虚拟机，即一主三从的K8S集群结构。</p>
<h2 id="9-4-NFS服务器搭建"><a href="#9-4-NFS服务器搭建" class="headerlink" title="9.4. NFS服务器搭建"></a>9.4. NFS服务器搭建</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1426918">https://www.kancloud.cn/mrbird/spring-cloud/1426918</a></p>
<p>在K8S中，我们虽然可以使用volume将容器内目录挂载到宿主机目录上，但由于Pod调度的不确定性，这种数据存储方式是不牢靠的。对于有状态的应用，我们希望无论Pod被调度到哪个节点上，它们的数据总能够完整地恢复，这时候我们就不能用volume挂载了，而应该使用“网络共享存储”。</p>
<h2 id="9-5-搭建Docker镜像仓库Harbor"><a href="#9-5-搭建Docker镜像仓库Harbor" class="headerlink" title="9.5. 搭建Docker镜像仓库Harbor"></a>9.5. 搭建Docker镜像仓库Harbor</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1426919">https://www.kancloud.cn/mrbird/spring-cloud/1426919</a></p>
<p>在本地环境下（或者公司局域网），将Docker镜像推送到Docker Hub速度比较慢，推荐的做法是安装一个第三方的Docker镜像仓库，这里推荐使用Harbor。Harbor是一款开源的Docker镜像存储仓库，其扩展了Docker Distribution，在此基础上添加了我们常用的功能，比如安全认证，RBAC用户权限管理，可视化页面操作等功能。</p>
<h2 id="9-6-K8S构建高可用Nacos"><a href="#9-6-K8S构建高可用Nacos" class="headerlink" title="9.6. K8S构建高可用Nacos"></a>9.6. K8S构建高可用Nacos</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1426920">https://www.kancloud.cn/mrbird/spring-cloud/1426920</a></p>
<h2 id="9-7-K8S构建FEBS-Cloud服务集群"><a href="#9-7-K8S构建FEBS-Cloud服务集群" class="headerlink" title="9.7. K8S构建FEBS Cloud服务集群"></a>9.7. K8S构建FEBS Cloud服务集群</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1426921">https://www.kancloud.cn/mrbird/spring-cloud/1426921</a></p>
<h2 id="9-8-部署前端测试"><a href="#9-8-部署前端测试" class="headerlink" title="9.8. 部署前端测试"></a>9.8. 部署前端测试</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1426922">https://www.kancloud.cn/mrbird/spring-cloud/1426922</a></p>
<h1 id="10-分布式事务研究"><a href="#10-分布式事务研究" class="headerlink" title="10. 分布式事务研究"></a>10. 分布式事务研究</h1><h2 id="10-1-分布式架构事务挑战"><a href="#10-1-分布式架构事务挑战" class="headerlink" title="10.1. 分布式架构事务挑战"></a>10.1. 分布式架构事务挑战</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1456143">https://www.kancloud.cn/mrbird/spring-cloud/1456143</a></p>
<h2 id="10-2-分布式事务解决方案"><a href="#10-2-分布式事务解决方案" class="headerlink" title="10.2. 分布式事务解决方案"></a>10.2. 分布式事务解决方案</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1456144">https://www.kancloud.cn/mrbird/spring-cloud/1456144</a></p>
<h2 id="10-3-基于消息中间件RocketMQ方案（一）"><a href="#10-3-基于消息中间件RocketMQ方案（一）" class="headerlink" title="10.3. 基于消息中间件RocketMQ方案（一）"></a>10.3. 基于消息中间件RocketMQ方案（一）</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1456145">https://www.kancloud.cn/mrbird/spring-cloud/1456145</a></p>
<h2 id="10-4-基于消息中间件RocketMQ方案（二）"><a href="#10-4-基于消息中间件RocketMQ方案（二）" class="headerlink" title="10.4. 基于消息中间件RocketMQ方案（二）"></a>10.4. 基于消息中间件RocketMQ方案（二）</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1456146">https://www.kancloud.cn/mrbird/spring-cloud/1456146</a></p>
<h2 id="10-5-基于TX-LCN方案"><a href="#10-5-基于TX-LCN方案" class="headerlink" title="10.5. 基于TX-LCN方案"></a>10.5. 基于TX-LCN方案</h2><p><a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1456147">https://www.kancloud.cn/mrbird/spring-cloud/1456147</a></p>
<h2 id="10-6-基于阿里Seata方案"><a href="#10-6-基于阿里Seata方案" class="headerlink" title="10.6. 基于阿里Seata方案"></a>10.6. 基于阿里Seata方案</h2><p>10.6. <a target="_blank" rel="noopener" href="https://www.kancloud.cn/mrbird/spring-cloud/1456148">https://www.kancloud.cn/mrbird/spring-cloud/1456148</a></p>
<ul>
<li>搭建Seata Server<br>Seata是一款开源的分布式事务解决方案，致力于提供高性能和简单易用的分布式事务服务。Seata 将为用户提供了 AT、TCC、SAGA（适合业务流程长、业务流程多的情况，所以本节不演示） 和 XA（截至2020年1月1日，该功能Seata还在开发中，所以也不演示） 事务模式，为用户打造一站式的分布式解决方案。</li>
</ul>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://example.com/2021/06/28/architecture/FEBS/%E6%90%AD%E5%BB%BA%E6%95%99%E7%A8%8B/" data-id="ckqg285w5005nrcfpbbgb2j1c" data-title="" class="article-share-link">Share</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2021/06/28/architecture/%E6%9E%B6%E6%9E%84%E5%B8%88%E5%A4%A7%E5%9E%8B%E9%A1%B9%E7%9B%AE%E5%AE%9E%E6%88%98/%E7%9B%AE%E5%BD%95/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          (no title)
        
      </div>
    </a>
  
  
    <a href="/2021/06/28/architecture/FEBS/%E5%BC%80%E5%8F%91%E6%95%99%E7%A8%8B/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title"></div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    

  
    

  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2021/06/">June 2021</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2021/06/28/product/%E9%9C%80%E6%B1%82%E8%B0%83%E7%A0%94%E7%9A%84%E5%86%85%E5%AE%B9%E5%92%8C%E5%B7%A5%E4%BD%9C%E6%8C%87%E5%BC%95/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/06/28/product/%E9%93%81%E8%B7%AF6C%E4%B8%9A%E5%8A%A1%E7%BB%93%E6%9E%84/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/06/28/product/%E9%9C%80%E6%B1%82%E8%B0%83%E7%A0%94%E5%8F%8A%E5%88%86%E6%9E%90%E6%96%B9%E6%B3%95/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/06/28/product/%E6%B0%B4%E7%94%B5%E7%AB%99%E7%94%9F%E4%BA%A7%E8%BF%90%E8%A1%8C%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/">(no title)</a>
          </li>
        
          <li>
            <a href="/2021/06/28/product/%E6%B0%B4%E7%94%B5%E5%8E%82%E8%BF%90%E8%A1%8C%E7%AE%A1%E7%90%86%E7%B3%BB%E7%BB%9F/">(no title)</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2021 John Doe<br>
      Powered by <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>