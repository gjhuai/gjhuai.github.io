<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no" />
<link rel="stylesheet" href="../theme/css/my.css" /><h1>第 6 章 脚本</h1>
<ul>
<li>6.1 概览</li>
<li>使用脚本的好处<ul>
<li>1、减少网络开销</li>
<li>2、原子操作</li>
<li>3、复用</li>
<li>脚本类似 SQL 数据库的存储过程</li>
</ul>
</li>
</ul>
<h1>第 7 章 持久化</h1>
<h2>7.1 RDB 方式</h2>
<ul>
<li>RDB 方式的持久化是通过快照（Snapshot）完成的，当符合一定条件是 Redis 会将内存中的所有数据生成一份副本并存储在硬盘上，一个过程称之为“快照”。</li>
<li>触发快照的情形：</li>
<li>1、根据配置规则进行自动快照。</li>
<li>2、用户执行 SAVE 或 BGSAVE 命令</li>
<li>3、执行 FLUSHALL 命令</li>
<li>4、执行复制（replication）时。</li>
</ul>
<h3>7.1.5 快照原理</h3>
<pre><code>- 1、fork: Redis 使用 fork 函数复制一份当前进程（父进程）的副本（子进程）；
- 2、写文件: 父进程继续接收并处理客户端发来的命令，而子进程开始将内存中的数据写入硬盘中的临时文件；
- 3、替换: 当子进程写入完所有数据后，会用该临时文件替换旧的 RDB 文件（dump.rdb），至此一次快照操作完成。
- 新的 RDB 文件存储的是执行 fork 一刻的内存数据。
- 任何时候 RDB 文件都是完整的。
- 写时复制策略也保证了在 fork 的时刻虽然看上去生成了两份内存副本，但实际上内存的占用量并不会增加一倍。
- 通过 RDB 方式实现持久化，一 旦 Redis 异常退出，就会丢失最后一次快照以后更改的所有数据。
- 希望将损失降到最小，则可以使用 AOF 方式进行持久化。
</code></pre>
<h2>7.2 AOF 方式</h2>
<ul>
<li>AOF 可以将 Redis 执行的每一条写命令追加到硬盘文件中，这一过程显然会降低 Redis 的性能。</li>
</ul>
<h1>第 8 章 集群</h1>
<h2>8.1 复制</h2>
<ul>
<li>Redis 提供了复制(replication) 功能，自动将更新的数据从主库同步到其他从库。</li>
<li>一主多从</li>
<li>原理：</li>
<li>从库启动后，向主库发送 SYNC 命令后，主库立即执行 RDB 快照，并缓存此期间接收到的命令；快照完成后，主库向从库发送快照文件和缓存命令；从库载入快照文件并执行缓存命令。完成复制初始化后，主库不断将写命令同步到从库。</li>
<li>主库之从库可以为下一级从库的主库。即可以构建多级复制的结构。</li>
<li>从库持久化</li>
<li>另一个相对耗时的操作是持久化，为了提高性能，可以通过复制功能建立-一个(或若干个)从数据库，并在从数据库中启用持久化，同时在主数据库禁用持久化。当从数据库崩溃重启后主数据库会自动将数据同步过来，所以无需担心数据丢失。</li>
<li>当开启复制且主数据库关闭持久化功能时，一-定不要使用 Supervisor 以及类似的进程管理工具令主数据库崩溃后自动重启。</li>
<li>哨兵能解决手工维护从库或主库的重启以及数据恢复的麻烦。</li>
<li>无硬盘复制</li>
<li>开启无硬盘复制选项后，Redis 在与从库进行复制初始化时将不会将快照内容存储到硬盘上，而是直接通过网络发送给从库，避免了硬盘的性能瓶颈。</li>
<li>增量复制</li>
</ul>
<h2>8.2 哨兵</h2>
<ul>
<li>哨兵包括两个功能：</li>
<li>1、监控主库和从库运行状态。</li>
<li>2、出现故障时，自动将从库转换为主库。</li>
<li>哨兵典型架构</li>
<li>多哨兵架构</li>
</ul>
<h2>8.3 集群</h2>
<ul>
<li>集群的特点在于拥有和单机实例同样的性能，同时在网络分区后能够提供一定的可访问性以及对主数据库故障恢复的支持。另外集群支持几乎所有的单机实例支持的命令，对于涉及多键的命令(如 MGET),如果每个键都位于同一个节点中，则可以正常支持，否则会提示错误。除此之外集群还有一个限制是只能使用默认的 0 号数据库，如果执行 SELECT 切换数据库则会提示错误。</li>
<li>哨兵与集群是两个独立的功能，但从特性来看哨兵可以视为集群的子集，当不需要数据分片或者已经在客户端进行分片的场景下哨兵就足够使用了，但如果需要进行水平扩容，则集群是一个非常好的选择。</li>
</ul>
<h1>第 9 章 管理</h1>
<h2>9.2 通信协议</h2>
<ul>
<li>Redis 支持两种通信协议，一种是二进制安全的统一请求协议( unified request protocol),另一种是比较直观的便于在 telnet 程序中输入的简单协议。这两种协议只是命令的格式有区别，命令返回值的格式是一样的。</li>
<li>Redis 的 AOF 文件和主从复制时，主数库向从库发送的内容都使用了统一请求协议。</li>
</ul>